# AI Learning Contract - mBot RuVector
# Reinforcement learning and predictive behavior system invariants

contract_meta:
  id: feature_ai_learning
  version: 2
  created_from_spec: "GitHub Issue #86, #87"
  covers_reqs:
    - I-AI-001
    - I-AI-002
    - I-AI-003
    - I-AI-004
    - I-AI-005
    - I-AI-006
    - I-AI-007
  owner: "mbot-ruvector-team"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_ai_learning"

rules:
  non_negotiable:
    - id: I-AI-001
      title: "Q-learning must converge within 1000 episodes for simple games"

    - id: I-AI-002
      title: "Learned policy must persist across sessions"

    - id: I-AI-003
      title: "Learning rate decay prevents oscillation after convergence"

    - id: I-AI-004
      title: "Exploration rate (epsilon) must decrease over time"
      rationale: "Prevent excessive exploration after learning stabilizes"
      scope:
        - "crates/mbot-core/src/learning/**/*.rs"

    - id: I-AI-005
      title: "Predictions require minimum 70% confidence threshold"
      rationale: "Low-confidence predictions should not trigger proactive actions"
      scope:
        - "crates/mbot-core/src/learning/prediction.rs"
      behavior:
        required_patterns:
          - pattern: /confidence\s*>=\s*0\.[67][0-9]/
            message: "Proactive actions require >=70% confidence (0.7)"
          - pattern: /min_confidence.*0\.7/
            message: "Default confidence threshold must be 0.7"
        example_compliant: |
          if prediction.confidence >= settings.min_confidence {
              suggest_action(prediction);
          }

    - id: I-AI-006
      title: "Pattern detection requires minimum observations"
      rationale: "Avoid false patterns from insufficient data (minimum 10 observations)"
      scope:
        - "crates/mbot-core/src/learning/prediction.rs"
      behavior:
        required_patterns:
          - pattern: /observations\s*>=\s*[0-9]+/
            message: "Patterns require minimum observations check"
          - pattern: /min_observations.*10/
            message: "Default minimum observations must be 10"
        example_compliant: |
          if pattern.observations >= settings.min_observations {
              patterns.push(pattern);
          }

    - id: I-AI-007
      title: "User can disable predictions and clear data"
      rationale: "Privacy and control - users own their data and can opt out"
      scope:
        - "crates/mbot-core/src/learning/prediction.rs"
      behavior:
        required_patterns:
          - pattern: /enabled.*bool/
            message: "Must have toggle to enable/disable predictions"
          - pattern: /clear|reset|delete_patterns/
            message: "Must allow clearing prediction data"
        forbidden_patterns:
          - pattern: /force|mandatory|required.*prediction/
            message: "Predictions must never be mandatory"
        example_compliant: |
          if settings.enabled {
              let prediction = engine.predict_next_action(context);
          }

          fn clear_all_data(&mut self) {
              self.patterns.clear();
              self.history.clear();
          }

test_hooks:
  tests:
    - file: "tests/contracts/ai_learning_test.rs"
      description: "Contract enforcement tests for AI learning invariants"
    - file: "tests/journeys/predictive-behavior.journey.spec.ts"
      description: "E2E test for predictive behavior engine (#87)"
