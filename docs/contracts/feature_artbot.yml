# ArtBot Contract - Basic Shape Drawing (ART-003)
# Invariants for shape drawing primitives

contract_meta:
  id: feature_artbot
  version: 1
  created_from_spec: "STORY-ART-003"
  covers_reqs:
    - ART-003
    - I-ART-003
    - I-ART-003a
    - ARCH-ART-002
    - ARCH-ART-003
    - ARCH-001
    - ARCH-002
  owner: "mbot-ruvector-team"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_artbot"

rules:
  non_negotiable:
    # I-ART-003: Shape Closure Tolerance
    - id: I-ART-003
      title: "Closed shapes must close within 5mm of start point"
      rationale: "Circles and spirals must visually close for recognizable shapes"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        required_patterns:
          - pattern: /closure_gap.*<.*5\.0|CLOSURE_TOLERANCE.*5\.0/
            message: "Must enforce 5mm closure tolerance for closed shapes"
        example_violation: |
          // WRONG - No closure validation
          fn draw_circle(radius: f32) -> Vec<Point> { ... }
        example_compliant: |
          // CORRECT - Validates closure
          const CLOSURE_TOLERANCE_MM: f32 = 5.0;
          fn draw_circle(radius: f32) -> ShapeResult {
            let result = generate_circle(radius);
            assert!(result.closure_gap < CLOSURE_TOLERANCE_MM);
            result
          }

    # I-ART-003a: Geometric Accuracy
    - id: I-ART-003a
      title: "Shape paths must have variance < 10% from ideal geometry"
      rationale: "Shapes must be recognizable as their intended form"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        required_patterns:
          - pattern: /path_variance.*<.*0\.1|VARIANCE_TOLERANCE.*0\.1/
            message: "Must enforce 10% variance tolerance"
        example_violation: |
          // WRONG - No variance tracking
          fn circle_points(r: f32) -> Vec<Point> { ... }
        example_compliant: |
          // CORRECT - Tracks and validates variance
          const VARIANCE_TOLERANCE: f32 = 0.10; // 10%
          fn circle_result(r: f32) -> ShapeResult {
            let result = generate_circle(r);
            assert!(result.path_variance < VARIANCE_TOLERANCE);
            result
          }

    # ARCH-ART-002: Command Queuing
    - id: ARCH-ART-002
      title: "Drawing commands must be queued, not immediate"
      rationale: "Allows smoothing and optimization before execution"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /execute_now|immediate_draw|direct_motor/
            message: "Commands must be queued, not executed immediately"
        required_patterns:
          - pattern: /commands_generated|CommandQueue|DrawCommand/
            message: "Must use command queue pattern"
        example_violation: |
          // WRONG - Direct execution
          fn draw_circle() { motor.drive_now(x, y); }
        example_compliant: |
          // CORRECT - Returns commands for queue
          fn draw_circle() -> Vec<DrawCommand> {
            let mut commands = Vec::new();
            commands.push(DrawCommand::Move { x, y });
            commands
          }

    # ARCH-ART-003: Paper Bounds
    - id: ARCH-ART-003
      title: "All drawing movements must respect physical paper bounds"
      rationale: "Prevents drawing off paper and damaging surfaces"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        required_patterns:
          - pattern: /PaperBounds|bounds_check|constrain_to_bounds|clamp.*bounds/
            message: "Must check and respect paper bounds"
        example_violation: |
          // WRONG - No bounds checking
          fn move_to(x: f32, y: f32) -> DrawCommand {
            DrawCommand::Move { x, y }
          }
        example_compliant: |
          // CORRECT - Constrains to bounds
          fn move_to(x: f32, y: f32, bounds: &PaperBounds) -> DrawCommand {
            DrawCommand::Move {
              x: x.clamp(bounds.min_x, bounds.max_x),
              y: y.clamp(bounds.min_y, bounds.max_y),
            }
          }

    # ARCH-001: no_std Compatible
    - id: ARCH-001-ART
      title: "Shape drawing must be no_std compatible"
      rationale: "Runs on ESP32 CyberPi which requires no_std"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /use std::/
            message: "Must use core:: or alloc:: for no_std compatibility"
          - pattern: /println!/
            message: "println! not available in no_std"
        required_patterns:
          - pattern: /#!\[no_std\]|cfg.*no_std|core::|alloc::/
            message: "Must be no_std compatible"

    # ARCH-002: Deterministic Rendering
    - id: ARCH-002-ART
      title: "Shape rendering must be deterministic for same inputs"
      rationale: "Reproducible behavior for testing and debugging"
      scope:
        - "crates/mbot-core/src/artbot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /rand::thread_rng|SystemTime::now/
            message: "Use seeded RNG and passed timestamps for determinism"
        required_patterns:
          - pattern: /&.*Position|&.*ShapeParams|fn.*->.*ShapeResult/
            message: "Functions must take inputs as parameters and return deterministic results"

  soft:
    - id: ART-010
      title: "Prefer iterators over Vec allocations where possible"
      suggestion: "Use impl Iterator for memory efficiency on embedded"

    - id: ART-011
      title: "Document shape accuracy assumptions"
      suggestion: "Comment on expected encoder accuracy and calibration needs"

compliance_checklist:
  before_editing_files:
    - question: "Adding a closed shape (circle, spiral)?"
      if_yes: "Validate closure gap < 5mm (I-ART-003)"
    - question: "Adding any shape drawing?"
      if_yes: "Ensure path variance < 10% (I-ART-003a)"
    - question: "Adding movement commands?"
      if_yes: "Queue commands, check bounds (ARCH-ART-002, ARCH-ART-003)"
    - question: "Using math functions?"
      if_yes: "Use libm/core versions for no_std (ARCH-001)"

test_hooks:
  tests:
    - file: "tests/contracts/artbot.test.ts"
      description: "Scans for ART-003 contract violations"
  rust_tests:
    - file: "crates/mbot-core/src/artbot/shapes.rs"
      description: "Unit tests for shape invariants"

# Shape Type Specifications
shape_specifications:
  circle:
    params:
      - name: radius
        type: f32
        unit: mm
        constraints: "1.0 <= radius <= 500.0"
    invariants:
      - "closure_gap < 5.0mm"
      - "path_variance < 0.10"
    segments: "max(12, radius / 5) segments for smooth curve"

  spiral:
    params:
      - name: start_radius
        type: f32
        unit: mm
        constraints: "1.0 <= start_radius <= 200.0"
      - name: end_radius
        type: f32
        unit: mm
        constraints: "1.0 <= end_radius <= 200.0"
      - name: turns
        type: f32
        constraints: "0.5 <= turns <= 20.0"
      - name: direction
        type: enum
        values: [Inward, Outward]
    invariants:
      - "final position within 5mm of expected endpoint"
      - "radius changes smoothly (no jumps > 5mm between segments)"

  line:
    params:
      - name: length
        type: f32
        unit: mm
        constraints: "1.0 <= length <= 1000.0"
      - name: angle
        type: f32
        unit: degrees
        constraints: "0.0 <= angle < 360.0"
    invariants:
      - "path_deviation < 5.0mm from straight"
      - "actual_length within 5% of requested"

  arc:
    params:
      - name: radius
        type: f32
        unit: mm
        constraints: "1.0 <= radius <= 500.0"
      - name: angle
        type: f32
        unit: degrees
        constraints: "1.0 <= angle <= 359.0"
    invariants:
      - "curvature_variance < 0.10"
      - "arc does not close into circle"

  scribble:
    params:
      - name: bounds_width
        type: f32
        unit: mm
      - name: bounds_height
        type: f32
        unit: mm
      - name: intensity
        type: f32
        constraints: "0.0 <= intensity <= 1.0"
      - name: seed
        type: u64
        note: "Required for determinism (ARCH-002)"
    invariants:
      - "all points within bounds"
      - "stroke density correlates with intensity"
