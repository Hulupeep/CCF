# GameBot Contract - mBot RuVector
# Physical Turn Detection System (GAME-007)

contract_meta:
  id: feature_gamebot
  version: 1
  created_from_spec: "docs/PRD.md"
  github_issue: "#35 STORY-GAME-007"
  covers_reqs:
    - ARCH-GAME-001
    - ARCH-GAME-002
    - ARCH-GAME-003
    - ARCH-GAME-004
    - GAME-001
    - GAME-002
    - GAME-003
    - GAME-004
    - GAME-005
    - GAME-006
    - GAME-007
  owner: "mbot-ruvector-team"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_gamebot"

# ============================================
# Data Contracts
# ============================================

data_contracts:
  TurnSignal:
    description: "Represents a detected turn signal from player"
    fields:
      - name: signal_type
        type: "TurnSignalType"
        description: "Type of signal detected"
        required: true
      - name: confidence
        type: "f32"
        range: [0.0, 1.0]
        description: "Confidence level (0-1); 1.0 for taps, 0.7-1.0 for voice"
        required: true
      - name: timestamp_us
        type: "u64"
        description: "Timestamp in microseconds when signal detected"
        required: true
      - name: raw_data
        type: "Option<String>"
        description: "Voice transcript if applicable"
        required: false

  TurnSignalType:
    description: "Enum of possible turn signal types"
    variants:
      - name: Tap
        description: "Single tap detected (ignored)"
      - name: DoubleTap
        description: "Double-tap within 400ms, >2g each"
      - name: Voice
        description: "Voice command detected"
      - name: Timeout
        description: "No input for timeout period"
      - name: App
        description: "Turn signal from companion app"

  TurnDetectionConfig:
    description: "Configuration for turn detection system"
    fields:
      - name: enabled_inputs
        type: "Vec<InputMethod>"
        description: "Which input methods are enabled"
        required: true
      - name: double_tap_threshold_ms
        type: "u32"
        default: 400
        description: "Maximum time between taps for double-tap"
      - name: double_tap_min_g
        type: "f32"
        default: 2.0
        description: "Minimum g-force for valid tap"
      - name: voice_keywords
        type: "Vec<String>"
        default: ["your turn", "go", "done", "roby"]
        description: "Keywords that trigger voice turn signal"
      - name: voice_confidence_threshold
        type: "f32"
        default: 0.7
        range: [0.0, 1.0]
        description: "Minimum confidence for voice detection"
      - name: timeout_seconds
        type: "u32"
        default: 30
        description: "Seconds before timeout prompt"

  InputMethod:
    description: "Enum of input methods"
    variants:
      - name: Tap
      - name: Voice
      - name: App

  TurnAcknowledgment:
    description: "Robot's acknowledgment of turn receipt"
    fields:
      - name: led_pattern
        type: "LedPattern"
        required: true
      - name: sound
        type: "AckSound"
        required: true
      - name: voice_response
        type: "Option<String>"
        description: "E.g., 'OK, my turn!' or 'Thinking...'"

  LedPattern:
    description: "LED patterns for acknowledgment"
    variants:
      - name: PulseBlue
        description: "Blue pulse for tap detection"
      - name: FlashGreen
        description: "Green flash for voice detection"
      - name: PulseYellow
        description: "Yellow pulse for timeout prompt"

  AckSound:
    description: "Sound types for acknowledgment"
    variants:
      - name: Beep
      - name: Chime
      - name: Voice

# ============================================
# Invariants
# ============================================

invariants:
  non_negotiable:
    - id: I-GAME-003
      title: "Thinking time bounded to 5 seconds max"
      rationale: "Player should not wait long for robot response"
      test_condition: "robot_think_time_ms <= 5000"
      enforcement: |
        After turn signal received, robot must acknowledge within 500ms
        and complete thinking within 5000ms.

    - id: I-GAME-006
      title: "No false positives during gameplay"
      rationale: "Accidental bumps or background noise must not trigger turn"
      test_condition: |
        - Single tap: no trigger
        - Bump < 2g: no trigger
        - Background noise < 60dB: no trigger
      enforcement: |
        Tap detection requires double-tap pattern.
        Voice detection requires confidence >= 0.7.
        Accelerometer threshold >= 2g.

    - id: I-GAME-007
      title: "Robot must always acknowledge turn receipt"
      rationale: "Player must never wonder 'did it hear me?'"
      test_condition: "acknowledgment_latency_ms <= 200"
      enforcement: |
        LED pulse within 200ms of detection.
        Voice response within 500ms.

  soft:
    - id: I-GAME-008
      title: "Detection disabled during robot's turn"
      suggestion: "Prevent accidental turn changes during robot move"

    - id: I-GAME-009
      title: "Configuration persists across power cycles"
      suggestion: "Store config in EEPROM or flash"

# ============================================
# Architecture Rules
# ============================================

rules:
  non_negotiable:
    - id: ARCH-GAME-001
      title: "Game state machine must be deterministic"
      rationale: "Reproducible game behavior for debugging"
      scope:
        - "crates/mbot-core/src/gamebot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /rand::thread_rng|SystemTime::now/
            message: "Use seeded RNG and passed timestamps"
        required_patterns:
          - pattern: /timestamp_us|tick_count/
            message: "Must use explicit timestamps"

    - id: ARCH-GAME-002
      title: "Turn detection must be interruptible"
      rationale: "Allow cancellation and state changes"
      scope:
        - "crates/mbot-core/src/gamebot/**/*.rs"
      behavior:
        required_patterns:
          - pattern: /process_input|handle_signal/
            message: "Input processing must be event-driven"

    - id: ARCH-GAME-003
      title: "Bounded response latency"
      rationale: "Real-time responsiveness for good UX"
      scope:
        - "crates/mbot-core/src/gamebot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /sleep|delay.*>.*1000/
            message: "No blocking delays > 1s in core logic"

    - id: ARCH-GAME-004
      title: "Physical-only mode support"
      rationale: "Games must work without companion app"
      scope:
        - "crates/mbot-core/src/gamebot/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /requires_app|app_only/
            message: "Core game logic must not require app"

  soft:
    - id: ARCH-GAME-010
      title: "Use EMA smoothing for sensor data"
      suggestion: "Exponential moving average prevents noise"

    - id: ARCH-GAME-011
      title: "Debounce all physical inputs"
      suggestion: "Prevent accidental double-triggers"

# ============================================
# Kitchen Table Test Safety
# ============================================

safety_rules:
  - id: SAFETY-GAME-001
    title: "No harmful responses to turn signals"
    scope:
      - "crates/mbot-core/src/gamebot/**/*.rs"
    behavior:
      forbidden_patterns:
        - pattern: /speed.*>.*100|motor.*>.*100/
          message: "Motor speeds must be limited"
        - pattern: /aggressive|attack|weapon/i
          message: "No harmful behavior terminology"

  - id: SAFETY-GAME-002
    title: "Volume limits on acknowledgment sounds"
    behavior:
      required_patterns:
        - pattern: /volume.*clamp|volume\.min/
          message: "Sound volume must be bounded"

# ============================================
# Test Hooks
# ============================================

test_hooks:
  contract_tests:
    - file: "tests/contracts/gamebot.test.ts"
      description: "Contract validation tests"

  journey_tests:
    - file: "tests/journeys/turn-detection.journey.spec.ts"
      description: "E2E journey tests for turn detection"

  rust_tests:
    - file: "crates/mbot-core/src/gamebot/turn_detection.rs"
      description: "Unit tests for turn detection module"

# ============================================
# Acceptance Criteria
# ============================================

acceptance_criteria:
  - id: AC-001
    description: "Double-tap on robot body triggers turn signal"
    test: "GAME-007-tap"

  - id: AC-002
    description: "Single tap is ignored (prevents accidental triggers)"
    test: "GAME-007-tap-negative"

  - id: AC-003
    description: "Voice command 'your turn' detected with >70% confidence"
    test: "GAME-007-voice"

  - id: AC-004
    description: "Voice command 'done' detected with >70% confidence"
    test: "GAME-007-voice"

  - id: AC-005
    description: "Voice command with name 'go Roby' detected"
    test: "GAME-007-voice"

  - id: AC-006
    description: "Robot responds with LED pulse within 200ms of detection"
    test: "GAME-007-acknowledgment"

  - id: AC-007
    description: "Robot says 'OK, my turn!' or 'Thinking...' after acknowledgment"
    test: "GAME-007-voice-response"

  - id: AC-008
    description: "Timeout prompt after 30s"
    test: "GAME-007-timeout"

  - id: AC-009
    description: "Works in reasonable ambient noise (<60dB background)"
    test: "GAME-007-voice-negative"

  - id: AC-010
    description: "No false positives during robot's own turn"
    test: "GAME-007-robot-turn-negative"

  - id: AC-011
    description: "Configuration persists across power cycles"
    test: "GAME-007-config"

# ============================================
# data-testid Requirements
# ============================================

data_testids:
  - id: "turn-signal-status"
    element: "Turn signal indicator"
    purpose: "Shows current detection state"

  - id: "turn-input-tap-toggle"
    element: "Input method toggle"
    purpose: "Enable/disable tap detection"

  - id: "turn-input-voice-toggle"
    element: "Input method toggle"
    purpose: "Enable/disable voice detection"

  - id: "turn-tap-sensitivity"
    element: "Sensitivity slider"
    purpose: "Adjust tap detection threshold"

  - id: "turn-voice-threshold"
    element: "Voice threshold"
    purpose: "Adjust voice confidence threshold"

  - id: "turn-test-tap"
    element: "Test tap button"
    purpose: "Test tap detection"

  - id: "turn-test-voice"
    element: "Test voice button"
    purpose: "Test voice detection"

# ============================================
# Gherkin Scenarios
# ============================================

gherkin_scenarios: |
  @GAME-007 @turn-detection @physical
  Feature: Physical Turn Detection System

    Background:
      Given a game is in progress
      And it is the human's turn
      And the robot is waiting for turn signal

    @GAME-007-tap @smoke
    Scenario: Double tap signals turn complete
      When the player double-taps the robot within 400ms
      Then the robot LED should pulse blue
      And the robot should say "OK, my turn!"
      And the game state should transition to robot's turn

    @GAME-007-tap @negative
    Scenario: Single tap is ignored
      When the player taps the robot once
      And waits 500ms
      Then the robot should not acknowledge
      And the game state should remain human's turn

    @GAME-007-tap @negative
    Scenario: Accidental bump is ignored
      When the robot experiences a bump less than 2g
      Then the robot should not acknowledge
      And the game state should remain human's turn

    @GAME-007-voice @smoke
    Scenario: Voice command "your turn" signals completion
      When the player says "your turn"
      And the confidence is above 0.7
      Then the robot LED should flash green
      And the robot should say "Got it!"
      And the game state should transition to robot's turn

    @GAME-007-voice
    Scenario: Voice command "done" signals completion
      When the player says "done"
      And the confidence is above 0.7
      Then the robot should acknowledge the turn
      And the game state should transition to robot's turn

    @GAME-007-voice
    Scenario: Voice command with name "go Roby"
      When the player says "go Roby"
      And the confidence is above 0.8
      Then the robot should respond enthusiastically
      And the game state should transition to robot's turn

    @GAME-007-voice @negative
    Scenario: Background noise does not trigger
      Given ambient noise level is 50dB
      When random conversation occurs nearby
      Then the robot should not acknowledge
      And the game state should remain human's turn

    @GAME-007-timeout
    Scenario: Timeout prompts player
      When 30 seconds pass without input
      Then the robot should say "Are you ready? Tap twice or say done"
      And the robot LED should pulse yellow
      And the game state should remain human's turn

    @GAME-007-config
    Scenario Outline: Configurable input methods
      Given turn detection config has enabled_inputs = ["<method>"]
      When the player uses <method> to signal
      Then the robot should acknowledge
      Examples:
        | method |
        | tap    |
        | voice  |

    @GAME-007-robot-turn @negative
    Scenario: Detection disabled during robot's turn
      Given it is the robot's turn
      When the player double-taps or says "done"
      Then the robot should not change turn state
