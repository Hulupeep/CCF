# Feature Contract - LEGO Sorter Vision System
# SORT-002: Sorting Loop Must Be Deterministic
# SORT-003: Color Detection Vision System
# SORT-005: Offline-First Operation

contract_meta:
  id: feature_sorter
  version: 1
  created_from_spec: "GitHub Issue #50"
  covers_reqs:
    - SORT-002
    - SORT-003
    - SORT-005
  owner: "mbot-ruvector-team"
  parent_epic: "EPIC-006 (LEGOSorter)"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_sorter"

# ============================================
# Architecture Invariants
# ============================================

rules:
  non_negotiable:
    - id: SORT-002
      title: "Sorting Loop Must Be Deterministic"
      rationale: "Same piece appearance must produce same color classification. Position detection must be repeatable."
      scope:
        - "crates/mbot-companion/src/sorter/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /rand::thread_rng|SystemTime::now\(\)/
            message: "Use seeded RNG and passed timestamps for determinism"
          - pattern: /\.shuffle\(\)|random\(\)/
            message: "No random operations in vision pipeline"
        required_patterns:
          - pattern: /fn classify_color.*(&self|&mut self).*->.*LegoColor/
            message: "Color classification must be a deterministic method"
        example_violation: |
          fn classify_color(&self) -> LegoColor {
              if rand::random() { LegoColor::Red } else { LegoColor::Blue }
          }
        example_compliant: |
          fn classify_color(&self, hsv: &HsvColor) -> LegoColor {
              for (color, range) in &self.calibration.color_ranges {
                  if range.contains(hsv) {
                      return *color;
                  }
              }
              LegoColor::Unknown
          }

    - id: SORT-003
      title: "Color Detection Vision System"
      rationale: "Detect LEGO pieces in tray with accurate color identification for pick operations"
      scope:
        - "crates/mbot-companion/src/sorter/**/*.rs"
      behavior:
        required_patterns:
          - pattern: /struct PieceObservation/
            message: "Must define PieceObservation struct for detected pieces"
          - pattern: /enum LegoColor/
            message: "Must define LegoColor enum for color classification"
          - pattern: /struct BoundingBox/
            message: "Must define BoundingBox for spatial detection"
          - pattern: /confidence.*f32|confidence.*f64/
            message: "Must track detection confidence as float"
          - pattern: /min_confidence/
            message: "Must support minimum confidence threshold"
        data_contracts:
          PieceObservation:
            required_fields:
              - observation_id: "String - unique identifier"
              - timestamp: "u64 - microseconds"
              - color: "LegoColor enum"
              - bbox: "BoundingBox struct"
              - confidence: "f32 in range 0.0-1.0"
              - center_position: "Position2D in millimeters"
              - estimated_size: "PieceSize enum (small/medium/large)"
            optional_fields:
              - coarse_type: "String - future brick type detection"
          LegoColor:
            variants:
              - "Red"
              - "Blue"
              - "Yellow"
              - "Green"
              - "Black"
              - "White"
              - "Orange"
              - "Purple"
              - "Tan"
              - "Gray"
              - "Brown"
              - "Unknown"
          BoundingBox:
            required_fields:
              - x: "u32 - top-left X in pixels"
              - y: "u32 - top-left Y in pixels"
              - width: "u32 - width in pixels"
              - height: "u32 - height in pixels"
          TrayRegion:
            required_fields:
              - top_left: "Position2D"
              - bottom_right: "Position2D"
              - background_color: "String - for contrast detection"
          VisionConfig:
            required_fields:
              - camera_id: "String"
              - tray_region: "TrayRegion"
              - min_confidence: "f32 - threshold for valid detection"
              - lighting_mode: "LightingMode enum"
              - color_calibration: "ColorCalibration"
          ColorCalibration:
            required_fields:
              - reference_samples: "Vec<ColorSample>"
              - last_calibrated: "u64 - timestamp"
            sub_types:
              ColorSample:
                required_fields:
                  - color: "LegoColor"
                  - hsv_range: "HsvRange with h, s, v bounds"

    - id: SORT-005
      title: "Offline-First Operation"
      rationale: "Vision processing runs locally on mBot/companion device. No cloud dependency for piece detection."
      scope:
        - "crates/mbot-companion/src/sorter/**/*.rs"
      behavior:
        forbidden_patterns:
          - pattern: /reqwest|hyper.*client|http.*client/i
            message: "No HTTP clients allowed - vision must be offline-first"
          - pattern: /aws|azure|gcloud|openai|anthropic/i
            message: "No cloud service dependencies for vision processing"
          - pattern: /async.*fn.*detect.*await/
            message: "Detection should be synchronous for offline reliability"
        required_patterns:
          - pattern: /impl.*ColorCalibration|impl.*VisionConfig/
            message: "Configuration must be local/file-based"
        example_violation: |
          async fn detect_color(&self, image: &[u8]) -> LegoColor {
              let response = client.post("https://api.vision.cloud/detect").await?;
              parse_cloud_response(response)
          }
        example_compliant: |
          fn detect_color(&self, hsv: &HsvColor) -> LegoColor {
              self.calibration.classify_hsv(hsv)
          }

  soft:
    - id: SORT-010
      title: "Prefer HSV over RGB for color detection"
      suggestion: "HSV colorspace is more robust to lighting variations"

    - id: SORT-011
      title: "Support calibration persistence"
      suggestion: "Color calibration should be saveable/loadable from file"

    - id: SORT-012
      title: "Provide confidence explanations"
      suggestion: "Low confidence should include reason (lighting, overlap, etc.)"

# ============================================
# Acceptance Criteria (Gherkin)
# ============================================

acceptance_criteria:
  feature: "Color Detection Vision System"
  actor: "mBot LEGO sorter"
  benefit: "I can pick and sort pieces correctly"

  scenarios:
    - name: "Detect single piece in empty tray"
      given:
        - "the overhead camera is active"
        - "the tray region is calibrated"
        - "the tray contains one red 2x4 brick"
      when:
        - "I capture and analyze the tray image"
      then:
        - "exactly one piece should be detected"
        - "the color should be Red with confidence >= 0.85"
        - "the bounding box should contain the piece"

    - name: "Detect multiple pieces"
      given:
        - "the tray contains pieces: red 2x4 brick, blue 1x4 plate, yellow 2x2 brick"
      when:
        - "I capture and analyze the tray image"
      then:
        - "3 pieces should be detected"
        - "each piece should have the correct color"

    - name: "Prioritize pieces for picking order"
      given:
        - "multiple pieces are detected"
      when:
        - "I request the next piece to pick"
      then:
        - "the piece closest to pick position should be returned"
        - "pieces should not overlap in pick order"

    - name: "Handle touching pieces"
      given:
        - "two pieces are touching in the tray"
      when:
        - "I analyze the tray image"
      then:
        - "both pieces should be detected separately"
        - "OR a cluster warning should be flagged"

    - name: "Reject low-confidence detections"
      given:
        - "a piece is partially obscured"
        - "detection confidence is 0.6"
        - "min_confidence is 0.75"
      when:
        - "I request valid detections"
      then:
        - "the obscured piece should be excluded"
        - "flagged as needs_reposition"

    - name: "Detect lighting issues"
      given:
        - "the tray lighting is too dim"
      when:
        - "I capture and analyze the image"
      then:
        - "a lighting_inadequate warning should appear"
        - "suggest improve_lighting_or_recalibrate"

    - name: "Handle shiny/reflective pieces"
      given:
        - "a chrome/metallic piece is in the tray"
      when:
        - "I analyze the tray image"
      then:
        - "the piece should be detected"
        - "color may be Unknown with confidence note"

    - name: "Color calibration with reference pieces"
      given:
        - "I have reference pieces of known colors"
      when:
        - "I run color calibration"
        - "place each reference piece in the tray"
        - "confirm its color"
      then:
        - "the HSV ranges should update"
        - "detection accuracy should improve"

    - name: "Empty tray detection"
      given:
        - "the tray is empty"
      when:
        - "I capture and analyze the tray image"
      then:
        - "no_pieces_detected should be reported"
        - "sorting loop should wait for pieces"

    - name: "Background contrast check"
      given:
        - "the tray has a white background"
        - "a white piece is placed"
      when:
        - "I analyze the image"
      then:
        - "a low_contrast warning should appear"
        - "suggest use_darker_tray_background"

# ============================================
# data-testid Requirements
# ============================================

test_ids:
  - element: "Camera preview"
    testid: "vision-preview"
    purpose: "Live camera feed display"

  - element: "Tray region overlay"
    testid: "tray-region-overlay"
    purpose: "Show detection zone boundaries"

  - element: "Piece detection boxes"
    testid: "piece-bbox-{id}"
    purpose: "Bounding box overlay per piece"

  - element: "Color label"
    testid: "piece-color-{id}"
    purpose: "Detected color text per piece"

  - element: "Confidence score"
    testid: "piece-confidence-{id}"
    purpose: "Detection confidence per piece"

  - element: "Piece count"
    testid: "detected-count"
    purpose: "Total pieces found display"

  - element: "Lighting indicator"
    testid: "lighting-status"
    purpose: "Adequate/Dim/Bright status"

  - element: "Calibration button"
    testid: "vision-calibrate"
    purpose: "Start color calibration flow"

  - element: "Capture button"
    testid: "vision-capture"
    purpose: "Manual capture trigger"

  - element: "Analysis status"
    testid: "vision-status"
    purpose: "Processing/Ready/Error state"

# ============================================
# E2E Test Reference
# ============================================

e2e_tests:
  - file: "tests/journeys/color-detection.journey.spec.ts"
    covers: ["SORT-002", "SORT-003", "SORT-005"]
    scenarios:
      - "single piece detection"
      - "multiple piece detection"
      - "color classification accuracy"
      - "confidence thresholding"
      - "lighting warnings"
      - "calibration flow"

# ============================================
# Compliance Checklist
# ============================================

compliance_checklist:
  before_editing_files:
    - question: "Adding color detection code?"
      if_yes: "Ensure offline-first (SORT-005) and deterministic (SORT-002)"
    - question: "Adding new color to LegoColor enum?"
      if_yes: "Update ColorCalibration with HSV ranges"
    - question: "Adding async operations?"
      if_yes: "Vision detection should be synchronous per SORT-005"
    - question: "Using external APIs or services?"
      if_yes: "BLOCKED - violates SORT-005 offline-first requirement"

# ============================================
# Definition of Done
# ============================================

definition_of_done:
  - "Detect LEGO pieces in tray with >=85% accuracy"
  - "Classify colors with >=80% accuracy on calibrated system"
  - "Return position suitable for arm pick operation"
  - "Handle edge cases (touching, reflective, low-light)"
  - "Color calibration improves accuracy"
  - "All Gherkin scenarios pass"
  - "SORT-002 and SORT-005 contracts enforced"
